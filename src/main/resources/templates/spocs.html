<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="utf-8" />
	<title>SPOC Master</title>

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

	<meta name="_csrf" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:content="${_csrf.headerName}" />

	<style>
		body {
			background: #f6f7fb;
			font-family: "Poppins", sans-serif;
		}

		h3 {
			font-weight: 600;
			color: #0d6efd;
		}

		.table-card {
			background: white;
			border-radius: 12px;
			border: 1px solid #eee;
			box-shadow: 0 4px 14px rgba(0, 0, 0, .06);
			overflow: hidden;
			transition: .2s;
		}

		.table-card:hover {
			box-shadow: 0 6px 20px rgba(0, 0, 0, .08);
		}

		thead {
			background: #0d6efd;
			color: white;
			font-size: 14px;
		}

		tbody tr:hover {
			background: #e9f2ff;
		}

		#editArea {
			background: white;
			padding: 20px;
			border-radius: 12px;
			margin-top: 20px;
			border: 1px solid #ddd;
			box-shadow: 0 4px 14px rgba(0, 0, 0, .05);
			animation: fadeIn .3s ease-in-out;
		}

		label {
			font-weight: 500;
		}

		input:focus {
			border-color: #0d6efd !important;
			box-shadow: rgba(13, 110, 253, .25) 0px 0px 0px 4px !important;
		}

		.btn-primary {
			padding: 3px 10px;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(10px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.badge-team {
			background: #0d6efd;
			padding: 5px 12px;
			border-radius: 8px;
			color: white;
			font-size: .8rem;
		}
	</style>
</head>

<body>

	<div th:replace="~{fragments/navbar :: fragment}"></div>

	<div class="container mt-4">
		<h3>SPOC Master</h3>

		<div class="table-card mt-3">
			<table class="table table-bordered table-striped m-0">
				<thead>
					<tr>
						<th>Team</th>
						<th>Primary Name</th>
						<th>Primary Email</th>
						<th>Primary Contact</th>
						<th>Secondary Name</th>
						<th>Secondary Email</th>
						<th>Secondary Contact</th>
						<th>Action</th>
					</tr>
				</thead>
				<tbody id="tbody"></tbody>
			</table>
		</div>

		<!-- Edit SPOC Panel -->
		<div id="editArea" style="display:none;">
			<h5 class="text-success">‚úèÔ∏è Edit SPOC Details</h5>

			<input id="spocId" type="hidden" />

			<div class="row mt-3">
				<div class="col-md-6 mb-2">
					<label>Your Name</label>
					<input id="lastUpdatedBy" class="form-control" placeholder="Updated by" />
				</div>

				<div class="col-md-6 mb-2">
					<label>Primary Name</label>
					<input id="primaryName" class="form-control" />
				</div>

				<div class="col-md-6 mb-2">
					<label>Primary Email</label>
					<input id="primaryEmail" class="form-control" />
				</div>

				<div class="col-md-6 mb-2">
					<label>Primary Contact</label>
					<input id="primaryContact" class="form-control" />
				</div>

				<div class="col-md-6 mb-2">
					<label>Secondary Name</label>
					<input id="secondaryName" class="form-control" />
				</div>

				<div class="col-md-6 mb-2">
					<label>Secondary Email</label>
					<input id="secondaryEmail" class="form-control" />
				</div>

				<div class="col-md-6 mb-2">
					<label>Secondary Contact</label>
					<input id="secondaryContact" class="form-control" />
				</div>

				<div class="col-12 mt-2">
					<button class="btn btn-success" onclick="saveSpoc()">üíæ Save</button>
					<button class="btn btn-outline-secondary btn-sm" onclick="closeEdit()">Cancel</button>
				</div>
			</div>
		</div>

	</div>

	<script>
		const csrfToken = document.querySelector('meta[name="_csrf"]').content;
		const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

		async function load() {
			const res = await fetch('/api/spocs');
			const list = await res.json();
			const tbody = document.getElementById('tbody');
			tbody.innerHTML = '';

			list.forEach(s => {
				const tr = document.createElement('tr');
				tr.innerHTML = `
                <td><span class="badge-team">${s.teamName}</span></td>
                <td>${s.primaryName || ''}</td>
                <td>${s.primaryEmail || ''}</td>
                <td>${s.primaryContact || ''}</td>
                <td>${s.secondaryName || ''}</td>
                <td>${s.secondaryEmail || ''}</td>
                <td>${s.secondaryContact || ''}</td>
                <td><button class="btn btn-sm btn-primary" onclick="edit(${s.id})">Edit</button></td>`;
				tbody.appendChild(tr);
			});
		}

		function edit(id) {
			fetch('/api/spocs').then(r => r.json()).then(list => {
				const s = list.find(x => x.id === id);

				document.getElementById('spocId').value = s.id;
				document.getElementById('primaryName').value = s.primaryName || '';
				document.getElementById('primaryEmail').value = s.primaryEmail || '';
				document.getElementById('primaryContact').value = s.primaryContact || '';
				document.getElementById('secondaryName').value = s.secondaryName || '';
				document.getElementById('secondaryEmail').value = s.secondaryEmail || '';
				document.getElementById('secondaryContact').value = s.secondaryContact || '';
				document.getElementById('lastUpdatedBy').value = "";

				document.getElementById('editArea').style.display = 'block';
				window.scrollTo(0, document.body.scrollHeight);
			});
		}

		function closeEdit() {
			document.getElementById('editArea').style.display = 'none';
		}

		async function saveSpoc() {
			const id = document.getElementById('spocId').value;

			const payload = {
				primaryName: document.getElementById('primaryName').value,
				primaryEmail: document.getElementById('primaryEmail').value,
				primaryContact: document.getElementById('primaryContact').value,
				secondaryName: document.getElementById('secondaryName').value,
				secondaryEmail: document.getElementById('secondaryEmail').value,
				secondaryContact: document.getElementById('secondaryContact').value,
				lastUpdatedBy: document.getElementById('lastUpdatedBy').value || 'Unknown'
			};

			const res = await fetch('/api/spocs/' + id, {
				method: 'PUT',
				headers: {'Content-Type': 'application/json', [csrfHeader]: csrfToken},
				body: JSON.stringify(payload),
				credentials: 'same-origin'
			});

			if (res.ok) {
				closeEdit();
				load();
			} else {
				alert('Save failed: ' + res.status);
			}
		}

		window.onload = load;
	</script>
</body>

</html>