<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="utf-8" />
	<title>SPOC Master</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
	<meta name="_csrf" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>

<body>
	<div th:replace="~{fragments/navbar :: fragment}"></div>
	<div class="container mt-4">
		<h3>SPOC Master (Static Groups)</h3>
		<table class="table table-bordered">
			<thead>
				<tr>
					<th>Team</th>
					<th>Primary Name</th>
					<th>Primary Email</th>
					<th>Primary Contact</th>
					<th>Secondary Name</th>
					<th>Secondary Email</th>
					<th>Secondary Contact</th>
					<th>Action</th>
				</tr>
			</thead>
			<tbody id="tbody"></tbody>
		</table>

		<div id="editArea" style="display:none;">
			<h5>Edit SPOC</h5>
			<input id="spocId" type="hidden" />
			<input id="lastUpdatedBy" class="form-control mb-2" placeholder="Your name" />
			<input id="primaryName" class="form-control mb-2" placeholder="Primary Name" />
			<input id="primaryEmail" class="form-control mb-2" placeholder="Primary Email" />
			<input id="primaryContact" class="form-control mb-2" placeholder="Primary Contact" />
			<input id="secondaryName" class="form-control mb-2" placeholder="Secondary Name" />
			<input id="secondaryEmail" class="form-control mb-2" placeholder="Secondary Email" />
			<input id="secondaryContact" class="form-control mb-2" placeholder="Secondary Contact" />
			<button class="btn btn-success" onclick="saveSpoc()">Save</button>
			<button class="btn btn-link" onclick="closeEdit()">Cancel</button>
		</div>
	</div>

	<script>
		const csrfToken = document.querySelector('meta[name="_csrf"]').content;
		const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

		async function load() {
			const res = await fetch('/api/spocs');
			const list = await res.json();
			const tbody = document.getElementById('tbody'); tbody.innerHTML = '';
			list.forEach(s => {
				const tr = document.createElement('tr');
				tr.innerHTML = `<td>${s.teamName}</td><td>${s.primaryName || ''}</td><td>${s.primaryEmail || ''}</td><td>${s.primaryContact || ''}</td><td>${s.secondaryName || ''}</td><td>${s.secondaryEmail || ''}</td><td>${s.secondaryContact || ''}</td><td><button class="btn btn-sm btn-primary" onclick="edit(${s.id})">Edit</button></td>`;
				tbody.appendChild(tr);
			});
		}

		function edit(id) {
			fetch('/api/spocs').then(r => r.json()).then(list => {
				const s = list.find(x => x.id === id);
				document.getElementById('spocId').value = s.id;
				document.getElementById('primaryName').value = s.primaryName || '';
				document.getElementById('primaryEmail').value = s.primaryEmail || '';
				document.getElementById('primaryContact').value = s.primaryContact || '';
				document.getElementById('secondaryName').value = s.secondaryName || '';
				document.getElementById('secondaryEmail').value = s.secondaryEmail || '';
				document.getElementById('secondaryContact').value = s.secondaryContact || '';
				document.getElementById('editArea').style.display = 'block';
				window.scrollTo(0, document.body.scrollHeight);
			});
		}
		function closeEdit() {document.getElementById('editArea').style.display = 'none';}

		async function saveSpoc() {
			const id = document.getElementById('spocId').value;
			const payload = {
				primaryName: document.getElementById('primaryName').value,
				primaryEmail: document.getElementById('primaryEmail').value,
				primaryContact: document.getElementById('primaryContact').value,
				secondaryName: document.getElementById('secondaryName').value,
				secondaryEmail: document.getElementById('secondaryEmail').value,
				secondaryContact: document.getElementById('secondaryContact').value,
				lastUpdatedBy: document.getElementById('lastUpdatedBy').value || 'unknown'
			};
			const res = await fetch('/api/spocs/' + id, {method: 'PUT', headers: {'Content-Type': 'application/json', [csrfHeader]: csrfToken}, body: JSON.stringify(payload), credentials: 'same-origin'});
			if (res.ok) {closeEdit(); load();} else alert('Save failed: ' + res.status);
		}

		window.onload = load;
	</script>
</body>

</html>