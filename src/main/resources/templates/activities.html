<!doctype html>
<html>
<head>
<<<<<<< Updated upstream
  <meta charset="utf-8" />
  <title>Activities - SPOC Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
=======
	<meta charset="utf-8" />
	<title>Activities</title>

	<!-- Bootstrap CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

	<!-- CSRF meta tags -->
	<meta name="_csrf" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:content="${_csrf.headerName}" />

	<style>
		body {
			background: #f8f9fa;
		}

		.page-title {
			font-weight: 600;
			margin-bottom: 10px;
			color: #0d6efd;
		}

		.table-wrapper {
			background: white;
			padding: 20px;
			border-radius: 10px;
			box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
		}

		table thead {
			background: #0d6efd;
			color: white;
		}

		tr:hover {
			background: #f1f7ff;
		}

		.btn-info {
			background: #0dcaf0 !important;
			border: none;
		}

		.btn-danger {
			background: #dc3545 !important;
			border: none;
		}

		.search-box {
			width: 300px;
			float: right;
		}

		.export-link {
			font-weight: 500;
			color: #0d6efd;
			text-decoration: none;
		}

		.export-link:hover {
			text-decoration: underline;
		}
	</style>
>>>>>>> Stashed changes
</head>
<body class="p-4">
<div class="container">
  <h2>Weekend Activities</h2>
  <div class="mb-3">
    <button class="btn btn-primary" onclick="showCreate()">Create Activity</button>
  </div>

<<<<<<< Updated upstream
  <table class="table table-bordered" id="activitiesTable">
    <thead><tr><th>ID</th><th>Name</th><th>Date</th><th>CreatedBy</th><th>Action</th></tr></thead>
    <tbody></tbody>
  </table>

  <div id="createArea" style="display:none; margin-top:20px;">
    <h4>Create Activity</h4>
    <input id="actName" class="form-control mb-2" placeholder="CR name e.g. CR1312 - Linux Patching" />
    <input id="actDate" type="date" class="form-control mb-2" />
    <input id="actBy" class="form-control mb-2" placeholder="Created By" />
    <button class="btn btn-success" onclick="createActivity()">Create</button>
    <button class="btn btn-link" onclick="hideCreate()">Cancel</button>
  </div>
</div>

<script>
async function loadActivities(){
  const res = await fetch('/api/activities');
  const list = await res.json();
  const tbody = document.querySelector('#activitiesTable tbody');
  tbody.innerHTML = '';
  list.forEach(a => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${a.id}</td><td>${a.name}</td><td>${a.activityDate||''}</td><td>${a.createdBy||''}</td><td><a href='/activities/${a.id}' class='btn btn-sm btn-info'>View</a></td>`;
    tbody.appendChild(tr);
  });
}
function showCreate(){document.getElementById('createArea').style.display='block';}
function hideCreate(){document.getElementById('createArea').style.display='none';}
async function createActivity(){
  const payload = { name: document.getElementById('actName').value, activityDate: document.getElementById('actDate').value, createdBy: document.getElementById('actBy').value };
  if(!payload.name){alert('Name required'); return}
  await fetch('/api/activities',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  hideCreate(); loadActivities();
}
window.onload = loadActivities;
</script>
=======
<body>

	<div th:replace="~{fragments/navbar :: fragment}"></div>

	<div class="container mt-4">

		<div class="d-flex justify-content-between align-items-center mb-2">
			<h3 class="page-title">Activities List</h3>

			<input type="text" class="form-control search-box" id="searchInput" placeholder="Search CR or name...">
		</div>

		<a href="/activities/export" class="export-link">ðŸ“¥ Export Report (Excel)</a>

		<div class="table-wrapper mt-3">
			<table class="table table-hover table-bordered align-middle">
				<thead>
					<tr>
						<th>ID</th>
						<th>CR Number</th>
						<th>Name</th>
						<th>Date</th>
						<th>Created By</th>
						<th style="width: 160px;">Action</th>
					</tr>
				</thead>
				<tbody id="activityTable">
					<tr th:each="a : ${activities}">
						<td th:text="${a.id}"></td>
						<td th:text="${a.crNumber}"></td>
						<td th:text="${a.name}"></td>
						<td th:text="${a.implementationDate}"></td>
						<td th:text="${a.createdBy}"></td>
						<td>
							<a th:href="@{|/activities/${a.id}|}" class="btn btn-sm btn-info">View</a>

							<!-- ADMIN delete button: use th:if and th:onclick to avoid inline [[...]] -->
							<button th:if="${#authorization.expression('hasRole(''ADMIN'')')}"
								class="btn btn-danger btn-sm" th:onclick="'deleteActivity(' + ${a.id} + ')'">
								Delete
							</button>

						</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>

	<script>
		// read CSRF from meta tags
		const csrfMeta = document.querySelector('meta[name="_csrf"]');
		const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
		const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : null;
		const csrfHeader = csrfHeaderMeta ? csrfHeaderMeta.getAttribute('content') : null;

		// delete function (will be invoked by th:onclick)
		async function deleteActivity(id) {
			if (!id) {
				alert('Invalid id');
				return;
			}
			if (!confirm('Are you sure you want to delete this CR?')) return;

			const headers = {'Content-Type': 'application/json'};
			if (csrfHeader && csrfToken) headers[csrfHeader] = csrfToken;

			const res = await fetch('/api/activities/' + id, {
				method: 'DELETE',
				headers,
				credentials: 'same-origin'
			});

			if (res.ok) {
				// optionally show a small message
				location.reload();
			} else {
				const text = await res.text().catch(() => res.status);
				alert('Delete failed: ' + text);
			}
		}

		// Search filter
		document.getElementById("searchInput").addEventListener("keyup", function () {
			let searchValue = this.value.toLowerCase();
			let rows = document.querySelector("#activityTable").rows;

			for (let i = 0; i < rows.length; i++) {
				// skip header or empty rows
				if (!rows[i].cells || rows[i].cells.length < 3) continue;
				let cr = (rows[i].cells[1].textContent || "").toLowerCase();
				let name = (rows[i].cells[2].textContent || "").toLowerCase();

				rows[i].style.display = (cr.includes(searchValue) || name.includes(searchValue)) ? "" : "none";
			}
		});
	</script>

>>>>>>> Stashed changes
</body>
</html>
