<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="utf-8" />
	<title>Activities</title>

	<!-- Bootstrap CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

	<!-- CSRF meta tags -->
	<!--<meta name="_csrf" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:content="${_csrf.headerName}" />-->

	<style>
		body {
			background: #f8f9fa;
		}

		.page-title {
			font-weight: 600;
			margin-bottom: 10px;
			color: #0d6efd;
		}

		.table-wrapper {
			background: white;
			padding: 20px;
			border-radius: 10px;
			box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
		}

		table thead {
			background: #0d6efd;
			color: white;
		}

		tr:hover {
			background: #f1f7ff;
		}

		.btn-info {
			background: #0dcaf0 !important;
			border: none;
		}

		.btn-danger {
			background: #dc3545 !important;
			border: none;
		}

		.search-box {
			width: 300px;
			float: right;
		}

		.export-link {
			font-weight: 500;
			color: #0d6efd;
			text-decoration: none;
		}

		.export-link:hover {
			text-decoration: underline;
		}
	</style>
</head>

<body>

	<div th:replace="~{fragments/navbar :: fragment}"></div>

	<div class="container mt-4">

		<div class="d-flex justify-content-between align-items-center mb-2">
			<h3 class="page-title">Activities List</h3>

			<input type="text" class="form-control search-box" id="searchInput" placeholder="Search CR or name...">
		</div>

		<a href="/activities/export" class="export-link">ðŸ“¥ Export Report (Excel)</a>

		<div class="table-wrapper mt-3">
			<table class="table table-hover table-bordered align-middle">
				<thead>
					<tr>
						<th>ID</th>
						<th>CR Number</th>
						<th>Name</th>
						<th>Date</th>
						<th>Created By</th>
						<th style="width: 160px;">Action</th>
					</tr>
				</thead>
				<tbody id="activityTable">
					<tr th:each="a : ${activities}">
						<td th:text="${a.id}"></td>
						<td th:text="${a.crNumber}"></td>
						<td th:text="${a.name}"></td>
						<td th:text="${a.implementationDate}"></td>
						<td th:text="${a.createdBy}"></td>
						<td>
							<a th:href="@{|/activities/${a.id}|}" class="btn btn-sm btn-info">View</a>

							<!-- ADMIN delete button: use th:if and th:onclick to avoid inline [[...]] -->
							<button th:if="${#authorization.expression('hasRole(''ADMIN'')')}"
								class="btn btn-danger btn-sm" th:onclick="'deleteActivity(' + ${a.id} + ')'">
								Delete
							</button>

						</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>

	<script>
		// read CSRF from meta tags
		const csrfMeta = document.querySelector('meta[name="_csrf"]');
		const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
		const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : null;
		const csrfHeader = csrfHeaderMeta ? csrfHeaderMeta.getAttribute('content') : null;

		// delete function (will be invoked by th:onclick)
		async function deleteActivity(id) {
			if (!id) {
				alert('Invalid id');
				return;
			}
			if (!confirm('Are you sure you want to delete this CR?')) return;

			const headers = {'Content-Type': 'application/json'};
			if (csrfHeader && csrfToken) headers[csrfHeader] = csrfToken;

			const res = await fetch('/api/activities/' + id, {
				method: 'DELETE',
				headers,
				credentials: 'same-origin'
			});

			if (res.ok) {
				// optionally show a small message
				location.reload();
			} else {
				const text = await res.text().catch(() => res.status);
				alert('Delete failed: ' + text);
			}
		}

		// Search filter
		document.getElementById("searchInput").addEventListener("keyup", function () {
			let searchValue = this.value.toLowerCase();
			let rows = document.querySelector("#activityTable").rows;

			for (let i = 0; i < rows.length; i++) {
				// skip header or empty rows
				if (!rows[i].cells || rows[i].cells.length < 3) continue;
				let cr = (rows[i].cells[1].textContent || "").toLowerCase();
				let name = (rows[i].cells[2].textContent || "").toLowerCase();

				rows[i].style.display = (cr.includes(searchValue) || name.includes(searchValue)) ? "" : "none";
			}
		});
	</script>

</body>

</html>