<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SPOC Portal</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="p-4">
	<div class="container">
		<h1 class="mb-4">SPOC Management Portal</h1>

		<div class="mb-3">
			<button class="btn btn-primary" onclick="showAddForm()">Add / Update SPOC</button>
			<button class="btn btn-secondary" onclick="exportCsv()">Export CSV</button>
		</div>

		<table class="table table-bordered" id="spocTable">
			<thead>
				<tr>
					<th>Team</th>
					<th>SPOC</th>
					<th>Email</th>
					<th>Contact</th>
					<th>Backup</th>
					<th>Last Updated</th>
					<th>Action</th>
				</tr>
			</thead>
			<tbody>
				<!-- rows inserted by script -->
			</tbody>
		</table>

		<!-- form modal (simple) -->
		<div id="formArea" style="display:none; margin-top:20px;">
			<h4 id="formTitle">Add / Update SPOC</h4>
			<div class="mb-2">
				<input id="teamName" class="form-control" placeholder="Team name (e.g., Unix)" />
			</div>
			<div class="mb-2">
				<input id="spocName" class="form-control" placeholder="SPOC full name" />
			</div>
			<div class="mb-2">
				<input id="email" class="form-control" placeholder="Email" />
			</div>
			<div class="mb-2">
				<input id="contact" class="form-control" placeholder="Contact number" />
			</div>
			<div class="mb-2">
				<input id="backup" class="form-control" placeholder="Backup SPOC" />
			</div>
			<div class="mb-2">
				<input id="updatedBy" class="form-control" placeholder="Your name" />
			</div>
			<button class="btn btn-success" onclick="saveSpoc()">Save</button>
			<button class="btn btn-link" onclick="hideForm()">Cancel</button>
		</div>
	</div>

	<script>
		async function load() {
			const res = await fetch('/api/spocs');
			const list = await res.json();
			const tbody = document.querySelector('#spocTable tbody');
			tbody.innerHTML = '';
			list.forEach(s => {
				const tr = document.createElement('tr');
				tr.innerHTML = `
        <td>${s.teamName || ''}</td>
        <td>${s.spocName || ''}</td>
        <td>${s.email || ''}</td>
        <td>${s.contactNumber || ''}</td>
        <td>${s.backupName || ''}</td>
        <td>${s.lastUpdatedTime ? new Date(s.lastUpdatedTime).toLocaleString() : ''}</td>
        <td><button class="btn btn-sm btn-primary" onclick='edit(${s.id})'>Edit</button></td>
      `;
				tbody.appendChild(tr);
			});
		}

		function showAddForm() {
			document.getElementById('formArea').style.display = 'block';
			document.getElementById('formTitle').innerText = 'Add / Update SPOC';
			clearForm();
		}

		function hideForm() {document.getElementById('formArea').style.display = 'none';}
		function clearForm() {
			['teamName', 'spocName', 'email', 'contact', 'backup', 'updatedBy'].forEach(id => document.getElementById(id).value = '');
		}

		async function saveSpoc() {
			const payload = {
				teamName: document.getElementById('teamName').value,
				spocName: document.getElementById('spocName').value,
				email: document.getElementById('email').value,
				contactNumber: document.getElementById('contact').value,
				backupName: document.getElementById('backup').value,
				lastUpdatedBy: document.getElementById('updatedBy').value
			};

			// check if team exists â†’ update else create
			const team = payload.teamName;
			if (!team) {alert('Team name required'); return;}

			const getRes = await fetch('/api/spocs/' + encodeURIComponent(team));
			if (getRes.status === 200) {
				const existing = await getRes.json();
				// update
				payload.id = existing.id;
				await fetch('/api/spocs/' + existing.id, {
					method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
				});
			} else {
				await fetch('/api/spocs', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)});
			}

			hideForm();
			load();
		}

		async function edit(id) {
			const res = await fetch('/api/spocs');
			const list = await res.json();
			const s = list.find(x => x.id === id);
			if (!s) return;
			document.getElementById('teamName').value = s.teamName || '';
			document.getElementById('spocName').value = s.spocName || '';
			document.getElementById('email').value = s.email || '';
			document.getElementById('contact').value = s.contactNumber || '';
			document.getElementById('backup').value = s.backupName || '';
			document.getElementById('updatedBy').value = s.lastUpdatedBy || '';
			document.getElementById('formArea').style.display = 'block';
		}

		async function exportCsv() {
			const res = await fetch('/api/spocs');
			const list = await res.json();
			const rows = [['Team', 'SPOC', 'Email', 'Contact', 'Backup', 'Last Updated']];
			list.forEach(s => rows.push([s.teamName || '', s.spocName || '', s.email || '', s.contactNumber || '', s.backupName || '', s.lastUpdatedTime || '']));
			const csv = rows.map(r => r.map(c => '"' + ('' + c).replace(/"/g, '""') + '"').join(',')).join('\n');
			const blob = new Blob([csv], {type: 'text/csv'});
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a'); a.href = url; a.download = 'spocs.csv'; a.click(); URL.revokeObjectURL(url);
		}

		window.onload = load;
	</script>
</body>

</html>