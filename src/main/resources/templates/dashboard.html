<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="utf-8" />
	<title>Dashboard</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
	<meta name="_csrf" th:content="${_csrf.token}" />
	<meta name="_csrf_header" th:content="${_csrf.headerName}" />
	<style>
		/* small visual polish */
		.status-badge {
			padding: .35rem .6rem;
			border-radius: .35rem;
			color: #fff;
			display: inline-block;
		}

		.bg-warning {
			background: #f0ad4e;
		}

		.bg-info {
			background: #5bc0de;
		}

		.bg-success {
			background: #5cb85c;
		}

		.bg-danger {
			background: #d9534f;
		}
	</style>
</head>

<body>
	<div th:replace="~{fragments/navbar :: fragment}"></div>

	<div class="container mt-4">
		<h3>CR Dashboard</h3>

		<div id="alertArea" style="margin-top:8px;"></div>

		<table class="table table-bordered table-striped mt-3">
			<thead>
				<tr>
					<th>Sr No</th>
					<th>CR Number</th>
					<th>Name</th>
					<th>Implementation Date</th>
					<th>Created By</th>
					<th>Pending SPOC Groups</th>
					<th>Status</th>
					<!-- Action column header only for admin -->
					<th th:if="${#authorization.expression('hasRole(''ADMIN'')')}">Action</th>
					<th>View</th>
				</tr>
			</thead>

			<tbody>
				<tr th:each="a,iter : ${activities}">
					<td th:text="${iter.index + 1}">1</td>
					<td th:text="${a.crNumber}">CR001</td>
					<td th:text="${a.name}">CR name</td>
					<td th:text="${a.implementationDate}">2025-11-10</td>
					<td th:text="${a.createdBy}">creator</td>

					<td>
						<!-- count of assignments with status PENDING -->
						<span th:text="${#lists.size(a.assignments.?[status.name() == 'PENDING'])}">0</span>
					</td>

					<!-- single expression for badge class (ternary inside one ${...}) -->
					<td>
						<span class="status-badge"
							th:classappend="${a.activityStatus != null ? (a.activityStatus.name() == 'PENDING' ? ' bg-warning' : (a.activityStatus.name() == 'STARTED' ? ' bg-info' : (a.activityStatus.name() == 'COMPLETED' ? ' bg-success' : ' bg-danger'))) : ' bg-warning'}"
							th:text="${a.activityStatus != null ? a.activityStatus.name() : 'PENDING'}">
						</span>
					</td>

					<!-- Admin-only action controls -->
					<td th:if="${#authorization.expression('hasRole(''ADMIN'')')}">
						<div style="min-width:150px;">
							<select class="form-select form-select-sm" th:id="'stact_' + ${a.id}">
								<option value="PENDING"
									th:selected="${a.activityStatus != null ? a.activityStatus.name()=='PENDING' : true}">
									PENDING</option>
								<option value="STARTED"
									th:selected="${a.activityStatus != null ? a.activityStatus.name()=='STARTED' : false}">
									STARTED</option>
								<option value="COMPLETED"
									th:selected="${a.activityStatus != null ? a.activityStatus.name()=='COMPLETED' : false}">
									COMPLETED</option>
								<option value="REJECTED"
									th:selected="${a.activityStatus != null ? a.activityStatus.name()=='REJECTED' : false}">
									REJECTED</option>
							</select>

							<button class="btn btn-sm btn-primary mt-1" th:attr="data-id=${a.id}"
								onclick="saveActivityStatus(this.dataset.id)">
								Save
							</button>
						</div>
					</td>


					<!-- View -->
					<td>
						<a th:href="@{/activities/{id}(id=${a.id})}" class="btn btn-sm btn-info">View</a>
					</td>
				</tr>
			</tbody>
		</table>
	</div>

	<script>
		// read CSRF meta tags
		const csrfMeta = document.querySelector('meta[name="_csrf"]');
		const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
		const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : null;
		const csrfHeader = csrfHeaderMeta ? csrfHeaderMeta.getAttribute('content') : null;

		function showAlert(type, msg) {
			const area = document.getElementById('alertArea');
			area.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
			setTimeout(() => area.innerHTML = '', 3500);
		}

		async function saveActivityStatus(id) {
			const sel = document.getElementById('stact_' + id);
			if (!sel) {
				showAlert('danger', 'Control not found');
				return;
			}
			const status = sel.value;
			try {
				const headers = {'Content-Type': 'application/json'};
				if (csrfHeader && csrfToken) headers[csrfHeader] = csrfToken;

				const res = await fetch('/api/activities/' + id + '/status', {
					method: 'PUT',
					headers,
					body: JSON.stringify({status})
				});
				if (res.ok) {
					showAlert('success', 'Activity status updated');
					setTimeout(() => location.reload(), 700);
				} else {
					const txt = await res.text();
					showAlert('danger', 'Error: ' + txt);
				}
			} catch (err) {
				showAlert('danger', 'Client error: ' + err.message);
				console.error(err);
			}
		}
	</script>
</body>

</html>